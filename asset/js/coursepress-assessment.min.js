/*! CoursePress - v2.0.0-BETA3
 * http://premium.wpmudev.org
 * Copyright (c) 2016; * Licensed GPLv2+ */
+function(a){CoursePress=CoursePress||{},CoursePress.Events=CoursePress.Events||_.extend({},Backbone.Events),CoursePress.Models.Units=CoursePress.Models.Post.extend({url:_coursepress._ajax_url+"?action=coursepress_assessments",parse:function(a){var b=this.get("action");1==a.success?this.trigger("coursepress:"+b+"_success",a.data):this.trigger("coursepress:"+b+"_error",a.data),this.set("action","")}}),CoursePress.UnitsPost=new CoursePress.Models.Units;var b=1,c="all",d=function(b,d){var e=a(".cp-unit-div").filter(function(){var c=a(this).data();return c.unit==b&&c.student==d}),f=a(".module-grade",e),g=a(".module-assessable .module-grade",e),h=0,i=a('.cp-total-unit-modules[data-unit="'+b+'"]').first().val();return"all"!=c&&(f=g),_.each(f,function(b){b=a(b);var c=b.val();c=c&&null!=c?parseInt(c):0,h+=c}),h=h>0&&i>0?Math.ceil(h/i):0},e=function(b){var d=a('.cp-unit-div[data-student="'+b+'"]'),e=0,f=a(".module-grade",d),g=a('.final-grade[data-student="'+b+'"], [data-student="'+b+'"] .final-grade'),h=0,i=d.parents(".cp-responses").first();"all"!=c&&(f=a(".module-assessable .module-grade",d)),_.each(f,function(b){b=a(b);var c=b.val();c=c&&null!=c?c:0,e+=parseInt(c)}),i.find(".cp-total-unit-modules").each(function(){var b=a(this),c=b.val();c=c&&null!=c?parseInt(c):0,h+=c}),e>0&&(e=Math.ceil(e/h)),g.html(e+"%")},f=function(){var b=a(this),c=b.siblings("button"),d=!b.is(".edit-no-feedback"),e=b.parents(".cp-grade-editor").first(),f=a(".module-grade",e),g=a(".cp-feedback-editor",e).hide(),i="cp_editor_"+f.data("module")+"_"+f.data("student"),j=a(".cp-grade-editor-box",e),k=(e.parents(".cp-unit-div").first(),a(".cp-edit-grade-box",e)),l=a(".cp-save-as-draft",e);b.is(".disabled")||(j.slideDown(),c.addClass("disabled"),d?(g.show(),h(i,g,e),k.appendTo(g),l.show()):(k.prependTo(j),l.hide()))},g=function(){var b=a(this),c=b.parents(".cp-grade-editor"),f=b.parents(".cp-module"),g=a(".cp-cancel",c),h=a(".module-grade",c),i=a(".cp_feedback_content",c),j=!!a(".edit-no-feedback").is(".disabled"),k=a(".cp-check",c),l=a(".cp-current-grade",c),m=parseInt(h.data("minimum")),n=parseInt(h.val()),o=n>=m,p=a(".cp-module-grade-info",c),q=a(".edit-with-feedback",c),r=a(".edit-no-feedback",c),s=h.data("unit"),t=h.data("module"),u=h.data("student"),v=c.parents(".cp-unit-div").first(),w=a(".unit-data .unit-grade",v);if(!b.is(".disabled")){var x=CoursePress.ProgressIndicator(),y={course_id:h.data("courseid"),unit_id:s,module_id:t,student_id:u,with_feedback:j,feedback_content:i.val(),student_grade:n,action:"update"};x.icon.insertAfter(this),CoursePress.UnitsPost.save(y),CoursePress.UnitsPost.off("coursepress:update_success"),CoursePress.UnitsPost.on("coursepress:update_success",function(b){CoursePress.Events.on("coursepress:progress:success",function(){g.trigger("click"),l.html(n+"%"),p.show(),o?k.removeClass("red").addClass("green").html(_coursepress.assessment_labels.pass):k.removeClass("green").addClass("red").html(_coursepress.assessment_labels.fail),q.html(_coursepress.assessment_labels.edit_with_feedback),r.html(_coursepress.assessment_labels.edit_no_feedback);var c=d(s,u);e(u);if(w.html(c+"%"),j&&""!=y.feedback_content.trim()){var h=a(".cp-instructor-feedback",f).show(),i=a(".cp-draft-icon",h);i[j?"hide":"show"](),a(".description",h).hide(),a(".cp-feedback-details",h).html(y.feedback_content),a("cite",h).html("- "+_coursepress.instructor_name)}var m=a('[data-student="'+u+'"] .cp-certified');m[!0===b.completed?"show":"hide"]()}),x.success()}),CoursePress.UnitsPost.on("coursepress:update_error",function(){x.error(_coursepress.server_error)})}},h=function(b,c,d){var e=a(".cp_feedback_content",d),f=e.val(),g=a(".wp-editor-container",c).length>0,h=a(".cp-submit-grade",d),i=a(".cp-save-as-draft",d);g||(CoursePress.Events.off("editor:keyup"),CoursePress.Events.on("editor:keyup",function(a){var b=a.getContent();b!=f&&(e.val(b),h.removeClass("disabled"),i.removeClass("disabled"))}),CoursePress.editor.create(c,b,b,f))},i=function(){var b=a(this),c=b.siblings(".cp-submit-grade");c[""!=b.val()?"removeClass":"addClass"]("disabled")},j=function(){var b=a(this),c=b.parents(".cp-grade-editor").first(),d=a(".cp-grade-editor-box",c),e=a(".cp-assessment-div button");d.slideUp(),e.removeClass("disabled")},k=function(){var b=a(this),c=b.parents(".cp-grade-editor"),d=b.parents(".cp-module"),e=a(".cp_feedback_content",c),f=a(".cp-cancel",c),g=a(".module-grade",c),h=g.data("courseid"),i=g.data("unit"),j=g.data("module"),k=g.data("student");if(!b.is(".disabled")){var l=CoursePress.ProgressIndicator();l.icon.addClass("cp-right").insertAfter(this);var m={course_id:h,unit_id:i,module_id:j,student_id:k,feedback_content:e.val(),action:"save_draft_feedback"};CoursePress.UnitsPost.save(m),CoursePress.UnitsPost.off("coursepress:save_draft_feedback_success"),CoursePress.UnitsPost.on("coursepress:save_draft_feedback_success",function(){CoursePress.Events.on("coursepress:progress:success",function(){b.addClass("disabled");var c=a(".cp-instructor-feedback",d).show();a(".cp-draft-icon",c).show();a(".description",c).hide(),a(".cp-feedback-details",c).html(m.feedback_content),a("cite",c).html("- "+_coursepress.instructor_name),f.trigger("click")}),l.success(_coursepress.assessment_labels.sucess)}),CoursePress.UnitsPost.off("coursepress:save_draft_feedback_error"),CoursePress.UnitsPost.on("coursepress:save_draft_feedback_error",function(){l.error(_coursepress.server_error)})}},l=function(){a(".cp-content script").each(function(){var b=a(this);template=b.html(),b.replaceWith(template)});var b=a(".cp-unit-div"),c=(a(".cp-table"),a(".student-row")),d=a("#unit-list").val();_.each(c,function(b){b=a(b);var c=b.data("student");e(c)}),_.each(b,function(b){b=a(b);var c=b.data("unit"),e=b.data("student"),f=a(".cp-toggle",b);m(c,e),f[d>0?"hide":"show"]()}),a(".cp-edit-grade-box").attr("data-title",_coursepress.assessment_labels.help_tooltip)},m=function(b,c){var e=d(b,c),f=a(".cp-unit-div .unit-grade");a('<span class="cp-check green">').html(_coursepress.assessment_labels.pass),a('<span class="cp-check red">').html(_coursepress.assessment_labels.fail);_.each(f,function(d){d=a(d);var f=d.data();f.unit==b&&f.student==c&&d.show().html(e+"%")})},n=function(){var c=a("#assessment-table-container"),d=a("#unit-list").val(),e=a("#ungraded-list").val(),f=a("#course-list").val(),g=a(".cp-loader-info"),h={course_id:f,unit_id:d,student_type:e,paged:b,action:"table"};c.empty(),g.show(),o(),CoursePress.UnitsPost.save(h),CoursePress.UnitsPost.off("coursepress:table_success"),CoursePress.UnitsPost.on("coursepress:table_success",function(a){c.html(a.html),g.hide(),l()}),CoursePress.UnitsPost.on("coursepress:table_error",function(){alert("Error!")})},o=function(){var c=a("#unit-list"),d=a("#ungraded-list"),e=a("#base_location").val();e+="&unit="+c.val()+"&type="+d.val(),b>1&&(e+="&paged="+b),history.pushState({},null,e)},p=function(){var c=a(this),d=(c.attr("href","javascript:;"),c.data("paged"));return b=d,n(),!1},q=function(){var b=a(this).val(),c=window.location.toString();c+="&display="+b,window.location=c},r=function(){var b=a(this),c=b.find(".dashicons"),d=b.siblings(),e=d.is(":visible");d[e?"slideUp":"slideDown"](),c[e?"removeClass":"addClass"]("dashicons-arrow-down"),c[e?"addClass":"removeClass"]("dashicons-arrow-up")},s=function(){var b=a(this),c=b.data(),d=c.student,e=a("#student-grade-"+d),f=a('.cp-content[data-student="'+d+'"]'),g=f.is(":visible");if(e.length>0){var h=e.html();e.replaceWith(h)}f[g?"hide":"show"](),b[g?"removeClass":"addClass"]("active")},t=function(){var b=a("#base_location").val(),c=a(this);b+="&course_id="+c.val(),window.location.assign(b)};CoursePress.Events.on("coursepress:assessment_loaded",function(){var b=a(".modules-answer-wrapper");b.length>0?(e(b.data("student")),a(".cp-edit-grade-box").attr("data-title",_coursepress.assessment_labels.help_tooltip)):n()}),a(document).ready(function(){CoursePress.Events.trigger("coursepress:assessment_loaded")}).on("change","#unit-list",n).on("change","#ungraded-list",n).on("click",".edit-no-feedback, .edit-with-feedback",f).on("click",".cp-submit-grade",g).on("change",".module-grade",i).on("click",".cp-cancel",j).on("click",".cp-edit-grade",s).on("click",".next-page, .last-page, .first-page, .prev-page",p).on("click",".modules-answer-wrapper .cp-toggle",r).on("click",".cp-save-as-draft",k).on("change","#grade-type",q).on("change","#course-list",t)}(jQuery);