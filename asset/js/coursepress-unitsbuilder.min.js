/*!  - v2.0.0
 * 
 * Copyright (c) 2016; * Licensed GPLv2+ */
var CoursePress=CoursePress||{};(function(e){function t(){CoursePress.UnitBuilder=new CoursePress.Views.UnitBuilder({el:"#unit-builder"})}CoursePress.Views=CoursePress.Views||{},CoursePress.Models=CoursePress.Models||{},CoursePress.Collections=CoursePress.Collections||{},CoursePress.Helpers=CoursePress.Helpers||{},CoursePress.Helpers.Module=CoursePress.Helpers.Module||{},CoursePress.Helpers.Module.quiz=CoursePress.Helpers.Module.quiz||{},CoursePress.Helpers.Module.refresh_ui=function(){e.each(e(".unit-builder-modules .editor"),function(t,s){var a=e(s).attr("id"),r=a.split("_");r.pop(),r=r.join("_");var i=RegExp(r,"gi");e.each(tinyMCEPreInit.mceInit,function(t,s){var r=s.selector.replace("#","");if(i.test(r)&&r!==a)try{delete tinyMCEPreInit.mceInit[r],delete tinyMCEPreInit.qtInit[r],delete tinyMCE.EditorManager.editors[r],e.each(tinyMCE.EditorManager.editors,function(e){try{var t=tinyMCE.EditorManager.editors[e].id;r===t&&delete tinyMCE.EditorManager.editors[e]}catch(s){}})}catch(n){}});var n=e("#"+a).val(),o=e(s).attr("name"),u=e(s).attr("data-height")?e(s).attr("data-height"):400;CoursePress.editor.create(s,a,o,n,!1,u)}),e(".unit-builder-modules").hasClass("ui-accordion")&&e(".unit-builder-modules").accordion("destroy");var t=0;if(CoursePress.UnitBuilder.activeModuleRef&&CoursePress.UnitBuilder.activeModuleRef.length>0){var s=e('[data-cid="'+CoursePress.UnitBuilder.activeModuleRef+'"]')[0];t=parseInt(e(s).attr("data-order"))-1}e(".unit-builder-modules").accordion({heightStyle:"content",collapsible:!0,header:"> div > h3",active:t}).sortable({axis:"y",handle:"h3",stop:function(t,s){s.item.children("h3").triggerHandler("focusout");var a=e(".module-holder");e.each(a,function(t,s){var a=parseInt(e(s).attr("data-order")),r=t+1,i=e(s).attr("data-cid");e(s).attr("data-order",r),a!==r&&(CoursePress.UnitBuilder.module_collection._byId[i].set_meta("module_order",r),e(s).addClass("dirty"))}),e(this).accordion("refresh")}}),e(".unit-builder-tabs ul").sortable({stop:function(){var t=e(".unit-builder-tabs ul li");e.each(t,function(t,s){var a=parseInt(e(s).attr("data-order")),r=t+1,i=e(s).attr("data-cid");if(e(s).attr("data-order",r),a!==r){var n=CoursePress.UnitBuilder.unit_collection._byId[i].get("meta");n.unit_order=r,CoursePress.UnitBuilder.unit_collection._byId[i].set("meta",n),CoursePress.UnitBuilder.unit_collection._byId[i].set("flag","dirty"),e(s).addClass("dirty")}})}}),e(".button.browse-media-field").browse_media_field(),e(".unit-builder-pager ul li").removeClass("active"),e('.unit-builder-pager ul li[data-page="'+CoursePress.UnitBuilder.activePage+'"]').addClass("active"),"publish"===CoursePress.UnitBuilder.activeUnitStatus?(e("#unit-live-toggle").removeClass("off"),e("#unit-live-toggle").addClass("on"),e("#unit-live-toggle-2").removeClass("off"),e("#unit-live-toggle-2").addClass("on")):(e("#unit-live-toggle").removeClass("on"),e("#unit-live-toggle").addClass("off"),e("#unit-live-toggle-2").removeClass("on"),e("#unit-live-toggle-2").addClass("off")),e(".coursepress-ui-toggle-switch").coursepress_ui_toggle(),1===CoursePress.UnitBuilder.totalPages?e(".unit-delete-page-button").addClass("hidden"):e(".unit-delete-page-button").removeClass("hidden"),e(".unit-builder-pager ul li[data-page]").droppable({activeClass:"page-droppable",hoverClass:"page-droppable-hover",accept:".unit-builder-modules .group",tolerance:"pointer",drop:function(t,s){var a=t.target,r=parseInt(e(a).attr("data-page")),i=CoursePress.UnitBuilder.activePage,n=s.draggable;if(i!==r){var o=e(e(n).find(".module-holder")[0]).attr("data-cid"),u=CoursePress.UnitBuilder.module_collection._byId[o].get("meta");u.module_page=r,u.module_order=u.module_order+900,CoursePress.UnitBuilder.module_collection._byId[o].set("meta",u),CoursePress.UnitBuilder.module_collection._byId[o].trigger("change"),e(n).detach()}}}),e(".dateinput").datepicker({dateFormat:"yy-mm-dd"}),e(".date").off("sync"),e(".date").on("click",function(){e(this).find(".dateinput").datepicker("show")});var a=e(".button-add-new-unit").position().top+e(".button-add-new-unit").innerHeight()+20,r=parseFloat(e("#unit-builder .tab-content").css("min-height").replace("px",""));818>r&&(r=818,e("#unit-builder .tab-content").css("min-height",r+"px")),a>r&&e("#unit-builder .tab-content").css("min-height",a+"px"),e(".unit-builder-body .quiz-action-button").off("click"),e(".unit-builder-body .quiz-action-button").on("click",function(){var t=this,s=e(t).parents(".module-components")[0],a=e(t).parents(".module-holder")[0],r=e(s).find(".quiz-question"),i=r.length,n=e(t).attr("data-type"),o='<div class="quiz-question question-'+(i+1)+'" data-id="'+(i+1)+'" data-type="'+n+'" style="position: relative; border: 1px solid rgba(0,0,0,0.2); margin-top: 10px; padding: 5px;">';o+='<div class="quiz-question-remove" style="position: absolute; top:5px; right:5px; font-weight: bolder; font-size: 1.2em; cursor: pointer;">X</div>';var u="",l='<div class="question-answer">';switch(n){case"single":var c="single-"+(i+1);u="Single Choice",l+='<div class="answer-group">',l+='<div class="answer"><input type="radio" name="'+c+'" value="" />',l+='<input class="component-radio-answer wide" type="text" value="Answer A" /><span class="remove-quiz-item"><i class="fa fa-trash-o"></i></span></div>',l+='<div class="answer"><input type="radio" name="'+c+'" value="" />',l+='<input class="component-radio-answer wide" type="text" value="Answer B" /><span class="remove-quiz-item"><i class="fa fa-trash-o"></i></span></div>',l+="</div>",l+='<a class="add-quiz-item">'+_coursepress.unit_builder_add_answer_label+"</a>";break;case"multiple":u="Multiple Choice",l+='<div class="answer-group">',l+='<div class="answer"><input type="checkbox" name="" value="" />',l+='<input class="component-checkbox-answer wide" type="text" value="Answer A" name="" /><span class="remove-quiz-item"><i class="fa fa-trash-o"></i></span></div>',l+='<div class="answer"><input type="checkbox" name="" value="" />',l+='<input class="component-checkbox-answer wide" type="text" value="Answer B" name="" /><span class="remove-quiz-item"><i class="fa fa-trash-o"></i></span></div>',l+="</div>",l+='<a class="add-quiz-item">'+_coursepress.unit_builder_add_answer_label+"</a>";break;case"short":u="Short Answer",l+='<div class="answer-group">',l+="<label>Placeholder:</label>",l+='<div class="placeholder"><input type="text" name="" value="Placeholder" />',l+="</div>";break;case"long":u="Long Answer",l+='<div class="answer-group">',l+="<label>Placeholder:</label>",l+='<div class="placeholder"><input type="text" name="" value="Placeholder" />',l+="</div>"}l+="</div>",o+='<label class="wide" data-key="label"><span class="label">'+u+":</span>"+"</label>",o+="<textarea></textarea>",o+=l,o+="</div>",e(s).append(o),CoursePress.Helpers.Module.quiz.update_meta(a),CoursePress.Helpers.Module.quiz.bind_buttons()}),CoursePress.Helpers.Module.quiz.bind_buttons()},CoursePress.Helpers.Module.quiz.render_component=function(t){var s=t.get_meta("questions");if(void 0===s||0>=s.length)return"";var a="";return e.each(s,function(t,s){a+='<div class="quiz-question question-'+(t+1)+'" data-id="'+(t+1)+'" data-type="'+s.type+'" style="position: relative; border: 1px solid rgba(0,0,0,0.2); margin-top: 10px; padding: 5px;">',a+='<div class="quiz-question-remove" style="position: absolute; top:5px; right:5px; font-weight: bolder; font-size: 1.2em; cursor: pointer;">X</div>';var r="",i='<div class="question-answer">';switch(s.type){case"single":r="Single Choice",i+='<div class="answer-group">',s.options.answers=s.options.answers||[],e.each(s.options.answers,function(e,a){var r=s.options.checked[e]?"checked=checked":"";i+='<div class="answer"><input type="radio" name="question'+(t+1)+'" value="" '+r+" />",i+='<input class="component-radio-answer wide" type="text" value="'+a+'" name="" /><span class="remove-quiz-item"><i class="fa fa-trash-o"></i></span></div>'}),i+="</div>",i+='<a class="add-quiz-item">'+_coursepress.unit_builder_add_answer_label+"</a>";break;case"multiple":r="Multiple Choice",i+='<div class="answer-group">',e.each(s.options.answers,function(e,t){var a=s.options.checked[e]?"checked=checked":"";i+='<div class="answer"><input type="checkbox" name="" value="" '+a+" />",i+='<input class="component-checkbox-answer wide" type="text" value="'+t+'" name="" /><span class="remove-quiz-item"><i class="fa fa-trash-o"></i></span></div>'}),i+="</div>",i+='<a class="add-quiz-item">'+_coursepress.unit_builder_add_answer_label+"</a>";break;case"short":break;case"long":}i+="</div>",a+='<label class="wide" data-key="label"><span class="label">'+r+":</span>"+"</label>",a+="<textarea>"+s.question+"</textarea>",a+=i,a+="</div>"}),a},CoursePress.Helpers.Module.quiz.update_meta=function(t){var s=e(t).attr("data-cid"),a={},r=CoursePress.UnitBuilder.module_collection._byId[s],i=e(t).find(".quiz-question");e.each(i,function(t,s){var r;switch(a[t]={type:e(s).attr("data-type"),question:e(s).find("textarea").val(),options:{}},a[t].type){case"single":a[t].options.answers=[],a[t].options.checked=[],r=e(s).find(".answer-group .answer"),window.console.log(r),e.each(r,function(s,r){a[t].options.answers[s]=e(r).find('[type="text"]').val(),a[t].options.checked[s]=e(r).find('[type="radio"]').is(":checked")});break;case"multiple":a[t].options.answers=[],a[t].options.checked=[],r=e(s).find(".answer-group .answer"),e.each(r,function(s,r){a[t].options.answers[s]=e(r).find('[type="text"]').val(),a[t].options.checked[s]=e(r).find('[type="checkbox"]').is(":checked")});break;case"short":break;case"long":}}),r.set_meta("questions",a),r.set("flag","dirty")},CoursePress.Helpers.Module.quiz.bind_add_item=function(){e(".quiz-question .add-quiz-item").off("click"),e(".quiz-question .add-quiz-item").on("click",function(){var t=this,s=e(t).parents(".quiz-question")[0],a=e(s).attr("data-type"),r="single"===a?"radio":"checkbox",i="single"===a?"component-radio-answer wide":"component-checkbox-answer wide",n=e(s).attr("data-type")+"-"+e(s).attr("data-id"),o='<div class="answer"><input type="'+r+'" value="" name="'+n+'">'+'<input type="text" name="" value="" class="'+i+'">'+'<span class="remove-quiz-item"><i class="fa fa-trash-o"></i></span>'+"</div>";e(s).find(".answer-group").append(o),CoursePress.Helpers.Module.quiz.bind_remove_item(),CoursePress.Helpers.Module.quiz.bind_checkboxes(),CoursePress.Helpers.Module.quiz.bind_textboxes()})},CoursePress.Helpers.Module.quiz.bind_checkboxes=function(){e('.quiz-question [type="checkbox"], .quiz-question [type="radio"]').off("change"),e('.quiz-question [type="checkbox"], .quiz-question [type="radio"]').on("change",function(){var t=e(this).parents(".module-holder")[0];CoursePress.Helpers.Module.quiz.update_meta(t)})},CoursePress.Helpers.Module.quiz.bind_textboxes=function(){e('.quiz-question [type="text"], .quiz-question textarea').off("keyup"),e('.quiz-question [type="text"], .quiz-question textarea').on("keyup",function(){var t=e(this).parents(".module-holder")[0];CoursePress.Helpers.Module.quiz.update_meta(t)})},CoursePress.Helpers.Module.quiz.bind_remove_item=function(){e(".quiz-question .remove-quiz-item").off("click"),e(".quiz-question .remove-quiz-item").on("click",function(){var t=this,s=e(t).parents(".answer")[0],a=e(this).parents(".module-holder")[0];e(s).detach(),CoursePress.Helpers.Module.quiz.update_meta(a)})},CoursePress.Helpers.Module.quiz.bind_remove_question=function(){e(".quiz-question .quiz-question-remove").off("click"),e(".quiz-question .quiz-question-remove").on("click",function(){var t=this,s=e(t).parents(".quiz-question")[0],a=e(s).siblings(".quiz-question"),r=e(this).parents(".module-holder")[0];window.console.log(a),e.each(a,function(t,s){e(s).attr("class",""),e(s).addClass("quiz-question"),e(s).addClass("question-"+(t+1)),e(s).attr("data-id",t+1)}),e(s).detach(),CoursePress.Helpers.Module.quiz.update_meta(r)})},CoursePress.Helpers.Module.quiz.bind_buttons=function(){CoursePress.Helpers.Module.quiz.bind_add_item(),CoursePress.Helpers.Module.quiz.bind_remove_item(),CoursePress.Helpers.Module.quiz.bind_remove_question(),CoursePress.Helpers.Module.quiz.bind_checkboxes(),CoursePress.Helpers.Module.quiz.bind_textboxes()},CoursePress.Helpers.Module.save_unit=function(t,s){e(".unit-buttons .unit-save-button").prepend('<i class="fa fa-spinner fa-spin save-progress"></i> ');var a=e("#unit-builder").attr("data-nonce");CoursePress.UnitBuilder.module_collection.url=_coursepress._ajax_url+"?action=unit_builder&task=modules_update&course_id="+_coursepress.course_id+"&unit_id="+CoursePress.UnitBuilder.activeUnitID+"&page="+CoursePress.UnitBuilder.activePage+"&wp_nonce="+a,Backbone.sync("update",CoursePress.UnitBuilder.module_collection,{success:function(t){e("#unit-builder").attr("data-nonce",t.nonce)},error:function(){}}),CoursePress.UnitBuilder.unit_collection.url=_coursepress._ajax_url+"?action=unit_builder&task=units_update&course_id="+_coursepress.course_id+"&wp_nonce="+a,Backbone.sync("update",CoursePress.UnitBuilder.unit_collection,{success:function(t){e(".save-progress").detach(),a=t.nonce,e("#unit-builder").attr("data-nonce",a),CoursePress.UnitBuilder.unit_collection.trigger(s)},error:function(){e(".save-progress").detach(),e(t.currentTarget).prepend('<i class="fa fa-info-circle save-progress"></i> ')}}),CoursePress.UnitBuilder.unit_collection.url=_coursepress._ajax_url+"?action=unit_builder&task=units&course_id="+_coursepress.course_id},CoursePress.Helpers.Module.toggle_unit_state=function(){var t=e("#unit-builder").attr("data-nonce");this.switch=function(t,s,a){"publish"===t?(e("#unit-live-toggle").removeClass("off"),e("#unit-live-toggle").addClass("on"),e("#unit-live-toggle-2").removeClass("off"),e("#unit-live-toggle-2").addClass("on")):(e("#unit-live-toggle").removeClass("on"),e("#unit-live-toggle").addClass("off"),e("#unit-live-toggle-2").removeClass("on"),e("#unit-live-toggle-2").addClass("off"));var r=CoursePress.UnitBuilder.unit_collection._byId[a].get("post_status");r!==t&&(CoursePress.UnitBuilder.unit_collection._byId[a].set("post_status",t),CoursePress.UnitBuilder.unit_collection._byId[a].trigger("change"),e('.unit-builder-tabs [data-tab="'+s+'"]').removeClass("unit-draft"),e('.unit-builder-tabs [data-tab="'+s+'"]').removeClass("unit-live"),"publish"===t?e('.unit-builder-tabs [data-tab="'+s+'"]').addClass("unit-live"):e('.unit-builder-tabs [data-tab="'+s+'"]').addClass("unit-draft"))};var s=this,a=CoursePress.UnitBuilder.activeUnitID,r=CoursePress.UnitBuilder.activeUnitRef,i=CoursePress.UnitBuilder.unit_collection._byId[r].get("post_status");i="publish"===i?"draft":"publish",CoursePress.UnitBuilder.unit_collection.url=_coursepress._ajax_url+"?action=unit_builder&task=unit_toggle&course_id="+_coursepress.course_id+"&wp_nonce="+t+"&state="+i+"&unit_id="+a,Backbone.sync("update",CoursePress.UnitBuilder.unit_collection,{success:function(t){s.switch(t.post_status,a,r),e("#unit-builder").attr("data-nonce",t.nonce)},error:function(t){s.switch(t.post_status,a,r),e("#unit-builder").attr("data-nonce",t.nonce)}}),CoursePress.UnitBuilder.unit_collection.url=_coursepress._ajax_url+"?action=unit_builder&task=units&course_id="+_coursepress.course_id},CoursePress.Helpers.Module.render_module=function(e,t){var s,a,r=_coursepress.unit_builder_module_types,i=_coursepress.unit_builder_module_labels;if(e.module_type()&&_coursepress.unit_builder_templates[e.module_type()].trim().length>0&&(a=JSON.parse(_coursepress.unit_builder_templates[e.module_type()])),void 0===a||void 0===_coursepress.unit_builder_module_types[a.type])return"";a.id=e.get("ID"),a.title=e.get("post_title"),a.duration=e.get_meta("duration"),a.type=e.module_type(),a.mode=r[a.type].mode,a.show_title=e.fix_boolean(e.get_meta("show_title")),a.mandatory=e.fix_boolean(e.get_meta("mandatory")),a.assessable=e.fix_boolean(e.get_meta("assessable")),a.minimum_grade=e.get_meta("minimum_grade",100),a.allow_retries=e.fix_boolean(e.get_meta("allow_retries")),a.retry_attempts=e.get_meta("retry_attempts",0),a.use_timer=e.fix_boolean(e.get_meta("use_timer"));var n=e.get("post_excerpt");if(n=n&&n.length>0?n:e.get("post_content"),a.content=n.trim(),a.order=e.get_meta("order",0),a.page=e.get_meta("page",1),s='<h3 class="module-holder-title '+a.type+'"><span class="label">'+a.title+'</span><span class="module-type">'+r[a.type].title+"</span></h3>"+'<div class="module-holder '+a.type+" mode-"+a.mode+'" data-id="'+a.id+'" data-type="'+a.type+'" data-order="'+t+'" data-cid="'+e.cid+'">',r[a.type].body&&"hidden"!==r[a.type].body||!r[a.type].body){if(s+='<div class="module-header"><label class="module-title"><span class="label">'+i.module_title+"</span>"+'<span class="description">'+i.module_title_desc+"</span>"+'<input class="module-title-text" type="text" name="post_title" value="'+a.title+'" /></label>',s+='<input type="hidden" name="meta_module_type" value="'+a.type+'" />',s+='<label class="module-duration"><span class="label">'+i.module_duration+"</span>"+'<input type="text" name="meta_duration" value="'+a.duration+'" /></label>',s+='<label class="module-show-title"><input type="checkbox" name="meta_show_title['+e.cid+']" value="1" '+CoursePress.utility.checked(a.show_title,1)+" />"+'<span class="label">'+i.module_show_title+"</span>"+'<span class="description">'+i.module_show_title_desc+"</span>"+"</label>",("input"===a.mode||"discussion"===a.type)&&(s+='<label class="module-mandatory"><input type="checkbox" name="meta_mandatory['+e.cid+']" value="1" '+CoursePress.utility.checked(a.mandatory,1)+" />"+'<span class="label">'+i.module_mandatory+"</span>"+'<span class="description">'+i.module_mandatory_desc+"</span>"+"</label>",s+='<label class="module-assessable"><input type="checkbox" name="meta_assessable['+e.cid+']" value="1" '+CoursePress.utility.checked(a.assessable,1)+" />"+'<span class="label">'+i.module_assessable+"</span>"+'<span class="description">'+i.module_assessable_desc+"</span>"+"</label>","input"===a.mode&&(s+='<label class="module-minimum-grade"><span class="label">'+i.module_minimum_grade+"</span>"+'<input type="text" name="meta_minimum_grade" value="'+a.minimum_grade+'" />'+'<span class="description">'+i.module_minimum_grade_desc+"</span>"+"</label>",s+='<label class="module-allow-retries"><input type="checkbox" name="meta_allow_retries['+e.cid+']" value="1" '+CoursePress.utility.checked(a.allow_retries,1)+" />"+'<span class="label">'+i.module_allow_retries+"</span>"+'<input type="text" name="meta_retry_attempts" value="'+a.retry_attempts+'" />'+'<span class="description">'+i.module_allow_retries_desc+"</span>"+"</label>","input-quiz"===a.type&&(s+='<label class="module-use-timer"><input type="checkbox" name="meta_use_timer['+e.cid+']" value="1" '+CoursePress.utility.checked(a.use_timer,1)+" />"+'<span class="label">'+i.module_use_timer+"</span><br />"+'<span class="description">'+i.module_use_timer_desc+"</span>"+"</label>"))),r[a.type].excerpt&&"hidden"!==r[a.type].excerpt||!r[a.type].excerpt){var o="";o=0===parseInt(a.id)||_.isNaN(parseInt(a.id))?"post_content_"+(new Date).getTime():"post_content_"+a.id+"_"+(new Date).getTime();var u=o,l="input"===a.mode?i.module_question:i.module_content,c="input"===a.mode?i.module_question_desc:i.module_content_desc,d=a.editor_height?'data-height="'+a.editor_height+'"':"";s+='<label class="module-excerpt"><span class="label">'+l+"</span>"+'<span class="description">'+c+"</span>"+'<textarea class="editor" name="'+o+'" id="'+u+'" '+d+">"+a.content+"</textarea>"+"</label>"}s+="</div>",s+='<div class="module-components">'+CoursePress.Helpers.Module.render_components(e,a)+"</div>"}return s+='<div class="unit-buttons"><div class="button unit-delete-module-button"><i class="fa fa-trash-o"></i> '+i.module_delete+"</div></div>",s+="</div>"},CoursePress.Helpers.Module.render_components=function(t,s){var a="",r=_.isArray(s.components)?s.components:[],i={};return e.each(r,function(s,r){var n=r.label?r.label:"",o=r.description?r.description:"",u=r["class"]?'class="'+r["class"]+'"':"",l=s,c="module-component-"+l;a+='<div class="module-component '+c+'">'+'<label data-key="label" '+u+">"+'<span class="label">'+n+"</span>"+'<span class="description">'+o+"</span></label>";var d=_.isArray(r.items)?r.items:[];e.each(d,function(s,r){var n,o,u,l,d,p,m,h,v,f=r.type?r.type:"";switch(f){case"text-input":var g=r.name.replace("meta_","");g=t.get_meta(g),n=r.name?' name="'+r.name+'"':"",n+=r["class"]?' class="'+r["class"]+'"':"",h=r.label?r.label:"";var b=r.label_tag?r.label_tag:"";p=r.placeholder?r.placeholder:"",h.length>1&&(a+="<"+b+">"+h+"</"+b+">"),a+='<input type="text"'+n+' value="'+g+'" placeholder="'+p+'" />';break;case"text":n=r["class"]?' class="'+r["class"]+'"':"",o=r.text?r.text:"",a+="<div"+n+">"+o+"</div>";break;case"select-select":case"radio-select":u=r.name?r.name:"",n=r["class"]?' class="'+r["class"]+'"':"",l=t.get_meta("answers"),l=l.length>0?l:r.answers,d=t.get_meta("answers_selected",parseInt(r.selected)),a+='<div class="answer-group">',e.each(l,function(e,s){_.isNaN(parseInt(d))&&(d=d===s?e:d),x=u+"_selected["+t.cid+"]",a+='<div class="answer"><input type="radio" name="'+x+'" value="'+e+'" '+CoursePress.utility.checked(parseInt(d),e)+" />",a+='<input type="text" '+n+' value="'+s+'" name="'+u+'[]" /> <span class="remove-item"></span><i class="fa fa-trash-o"></i></span></div>'}),a+="</div>",a+='<a class="add-item">'+_coursepress.unit_builder_add_answer_label+"</a>";break;case"checkbox-select":u=r.name?r.name:"",n=r["class"]?' class="'+r["class"]+'"':"",l=t.get_meta("answers"),l=l.length>0?l:r.answers,d=t.get_meta("answers_selected"),d=d.length>0?d:r.selected,_.isNaN(parseInt(d[0]))&&e.each(d,function(e,t){d[e]=_.indexOf(l,t)}),a+='<div class="answer-group">',e.each(l,function(e,s){var r=_.indexOf(d,e)>-1?'checked="checked"':"";x=u+"_selected["+t.cid+"][]",a+='<div class="answer"><input type="checkbox" name="'+x+'" value="'+e+'" '+r+" />",a+='<input type="text" '+n+' value="'+s+'" name="'+u+'[]" /> <span class="remove-item"><i class="fa fa-trash-o"></i></span></div>'}),a+="</div>",a+='<a class="add-item">'+_coursepress.unit_builder_add_answer_label+"</a>";break;case"media-caption-settings":m=r["class"]?' class="'+r["class"]+'"':"";var C=r.option_class?' class="'+r.option_class+'"':"",w=r.label?r.label:"",P=r.option_labels?r.option_labels.media:"",y=r.option_labels?r.option_labels.custom:"";p=r.placeholder?r.placeholder:"";var k=r.enable_name?r.enable_name:"",x=r.option_name?r.option_name:"",I=r.input_name?r.input_name:"",V=r.no_caption?r.no_caption:"",M=t.get_meta(k),q=t.get_meta(x),U=t.get_meta(I);k=k+"["+t.cid+"]",x=x+"["+t.cid+"]",a+="<div "+m+">"+'<label><input type="checkbox" value="1" name="'+k+'" '+CoursePress.utility.checked(M,1)+" />"+"<span>"+w+"</span></label>"+"<div "+C+">"+'<label><input type="radio" value="media" name="'+x+'" '+CoursePress.utility.checked(q,"media")+" />"+"<span>"+P+"</span></label>"+'<div class="existing">'+V+"</div>"+'<label><input type="radio" value="custom" name="'+x+'" '+CoursePress.utility.checked(q,"custom")+" />"+"<span>"+y+"</span></label><br />"+'<input type="text" placeholder="'+p+'" value="'+U+'" name="'+I+'" />'+"</div>"+"</div>",i.media_url&&i.media_url.length>0&&(CoursePress.utility.attachment_by_url(i.media_url,"."+c+" .existing",V),i.media_url=null);break;case"media-browser":var z=r.media_type?r.media_type:"image",E=r["class"]?r["class"]:"";m=r.container_class?r.container_class:"";var B=r.button_text?r.button_text:"";p=r.placeholder?r.placeholder:"",u=r.name?r.name:"",v=t.get_meta(u,""),a+=CoursePress.UI.browse_media_field(u,u,{value:v,type:z,container_class:m,textbox_class:E,placeholder:p,button_text:B}),i.media_url=v;break;case"checkbox":u=r.name?r.name:"",h=r.label?r.label:"",v=t.get_meta(u,""),x=u+"_selected["+t.cid+"]",a+='<label class="normal"><input type="checkbox" value="1" name="'+u+'" '+CoursePress.utility.checked(v,1)+" />"+"<span>"+h+"</span></label>";break;case"action":var H=r["class"]||"",T=r.action||"";a+='<div class="'+H+'" data-type="'+T+'"><a></a></div>';break;case"quiz":a+=CoursePress.Helpers.Module.quiz.render_component(t)}}),a+="</div>"}),a},CoursePress.Views.UnitBuilder=Backbone.View.extend({initialize:function(){this.unit_collection=new CoursePress.Collections.UnitTabs,this.unit_collection.url=_coursepress._ajax_url+"?action=unit_builder&task=units&course_id="+_coursepress.course_id,this.unit_collection.fetch(),this.module_collection=new CoursePress.Collections.UnitModules,this.tabViewCollection=new CoursePress.Views.UnitTabViewCollection({model:this.unit_collection,tagName:"ul",className:"sticky-tabs"}),this.tabViewCollection.parentView=this,this.headerView=new CoursePress.Views.UnitBuilderHeader,this.headerView.parentView=this,this.contentView=new CoursePress.Views.UnitBuilderBody({model:this.module_collection,className:"unit-builder-body"}),this.contentView.parentView=this,this.activePage=1,this.totalPages=1,this.activeUnitStatus="draft",this.activeModuleRef="",this.render()},events:{"click .unit-save-button":"saveUnit","change #unit-live-toggle":"toggleUnitState","change #unit-live-toggle-2":"toggleUnitState","click .unit-delete-module-button":"deleteModule","click .unit-delete-page-button":"deletePage","click .unit-delete-button":"deleteUnit","click .button-add-new-unit":"newUnit","click .unit-builder-tabs ul.sticky-tabs li":"changeActive"},render:function(){var t=_.template(e("#unit-builder-template").html(),{});return this.$el.html(t),this.$(".unit-builder-tabs .sticky-wrapper .tabs").replaceWith(this.tabViewCollection.el),this.$(".unit-builder-header").append(this.headerView.el),this.$(".unit-builder-body").replaceWith(this.contentView.el),e(".sticky-wrapper-tabs").sticky({topSpacing:45}),this},fetchModules:function(e,t){this.module_collection.url=_coursepress._ajax_url+"?action=unit_builder&task=modules&course_id="+_coursepress.course_id+"&unit_id="+e+"&page="+t,this.module_collection.fetch();var s=this.unit_collection._byId[this.activeUnitRef].get("meta");this.totalPages=s.page_title?s.page_title.length:1,this.totalPages=void 0===this.totalPages?_.size(s.page_title):1,this.activeModuleRef=""},saveUnit:function(e){CoursePress.Helpers.Module.save_unit(e)},toggleUnitState:function(e){CoursePress.Helpers.Module.toggle_unit_state(e)},deleteModule:function(t){if(window.confirm(_coursepress.unit_builder_delete_module_confirm)){var s=t.currentTarget,a=e(s).parents(".module-holder")[0],r=e(a).attr("data-cid");this.module_collection.remove(r),e(a).parents(".group").detach()}},deletePage:function(t){var s=this;if(window.confirm(_coursepress.unit_builder_delete_page_confirm)){var a=parseInt(this.activePage),r=s.unit_collection._byId[s.activeUnitRef].get("meta"),i=r.page_title,n=r.show_page_title,o=[],u={},l=0;e.each(n,function(e,t){if(e===a-1&&(l=-1),e!==a-1){o.push(t);var s=e+1+l;u["page_"+s]=i["page_"+(e+1)]}}),r.page_title=u,r.show_page_title=o,s.unit_collection._byId[s.activeUnitRef].set("meta",r),s.unit_collection._byId[s.activeUnitRef].trigger("change"),s.totalPages=r.show_page_title.length,s.module_collection.each(function(e){var t=e.get("meta");t.module_page=1,t.module_order+=999,e.set("meta",t),e.trigger("change")}),CoursePress.Helpers.Module.save_unit(t),s.fetchModules(s.activeUnitID,1)}},deleteUnit:function(t){window.confirm(_coursepress.unit_builder_delete_unit_confirm)&&(this.unit_collection.remove(this.activeUnitRef),e('ul li[data-tab="'+this.activeUnitID+'"]').detach(),e(e(".unit-builder-body")[0]).empty(),e('.unit-detail input[type="text"]').val(""),e('.unit-detail input[type="checkbox"]').removeAttr("checked"),e("#unit-live-toggle").removeClass("on").addClass("off"),e("#unit-live-toggle-2").removeClass("on").addClass("off"),e(e('li[data-tab="units"] a')[0]).html(e(e('li[data-tab="units"] a')[0]).html().replace(/\d+/,e(".unit-builder-tabs ul li").length)),CoursePress.Helpers.Module.save_unit(t))},newUnit:function(t){var s=this,a=e(".unit-builder-tabs .sticky-tabs li").length,r=new CoursePress.Models.Unit;r.set_meta("unit_order",a+1),r.set_meta("page_title",{page_1:""}),r.set_meta("show_page_title",[!0]),r.set("post_title",_coursepress.unit_builder_new_unit_title),s.unit_collection.add(r),CoursePress.Helpers.Module.save_unit(t,"new_success");var i=new CoursePress.Views.UnitTabView({model:r,tagName:"li"}),n=i.render().$el;e(".button-add-new-unit .fa").removeClass("fa-plus-square").addClass("fa-spinner").addClass("fa-spin"),s.unit_collection.on("new_success",function(){s.unit_collection.fetch({success:function(){e(".button-add-new-unit .fa").removeClass("fa-spin").removeClass("fa-spinner").addClass("fa-plus-square"),e(".unit-builder-tabs ul.sticky-tabs").append(n),CoursePress.Helpers.Module.refresh_ui(),e(e('li[data-tab="units"] a')[0]).html(e(e('li[data-tab="units"] a')[0]).html().replace(/\d+/,e(".unit-builder-tabs ul li").length))}}),s.unit_collection.off("new_success")})},changeActive:function(t){e("#unit-builder .tab-tabs li").removeClass("active"),e(t.currentTarget).addClass("active");var s=e(t.currentTarget).attr("data-tab"),a=this;this.unit_collection.each(function(e){parseInt(s)===parseInt(e.get("ID"))&&CoursePress.Helpers.changeUnit(e,a)})}}),CoursePress.Models.Unit=Backbone.Model.extend({initialize:function(){this.url=_coursepress._ajax_url+"?action=unit_builder&task=unit_update&course_id="+_coursepress.course_id+"&unit_id="+CoursePress.UnitBuilder.activeUnitID,this.on("change",this.process_changed,this),this.on("sync",this.model_saved,this)},set_meta:function(e,t){e=e.replace("meta_","");var s=this.get("meta")||{};s[e]=t,this.set("flag","dirty"),this.set("meta",s),this.trigger("change")},set_page_title:function(e,t){var s=this.get("meta")||{};s.page_title=s.page_title||{},s.page_title["page_"+e]=t,this.set("meta",s),this.trigger("change")},set_page_description:function(e,t){var s=this.get("meta")||{};s.page_description=s.page_description||{},s.page_description["page_"+e]=t,this.set("meta",s),this.trigger("change")},set_page_image:function(e,t){var s=this.get("meta")||{};s.page_feature_image=s.page_feature_image||{},s.page_feature_image["page_"+e]=t,this.set("meta",s),this.trigger("change")},set_page_visibility:function(e,t){var s=this.get("meta")||{},a=e-1;s.show_page_title&&(s.show_page_title[a]=t,this.set("meta",s),this.trigger("change"))},get_page_title:function(e){var t=this.get("meta")||{};return t.page_title?t.page_title["page_"+e]:""},get_page_description:function(e){var t=this.get("meta")||{};return t.page_description?t.page_description["page_"+e]:""},get_page_image:function(e){var t=this.get("meta")||{};return t.page_feature_image?t.page_feature_image["page_"+e]:""},get_page_visibility:function(e){var t=this.get("meta")||{};return t.show_page_title?t.show_page_title[e-1]:!0},process_changed:function(){this.set("flag","dirty")},model_saved:function(){}}),CoursePress.Models.Module=Backbone.Model.extend({initialize:function(){var t=e("#unit-builder").attr("data-nonce");this.url=_coursepress._ajax_url+"?action=unit_builder&task=module_add&course_id="+_coursepress.course_id+"&unit_id="+CoursePress.UnitBuilder.activeUnitID+"&wp_nonce="+t,this.on("change",this.process_changed,this),this.on("sync",this.model_saved,this)},get_meta:function(e,t){e=e.replace("meta_",""),void 0===t&&(t="");var s=this.get("meta")||{},a=s[e]?s[e]:t,r=_.isString(a)?a.toLowerCase():a;return("yes"===r||"on"===r||"no"===r||"off"===r)&&(a=this.fix_boolean(a)),(0===a.length||a===!1||0===a)&&(a=this.get_legacy_meta(e,t)),a},get_legacy_meta:function(e,t){var s,a;switch(e){case"duration":e="time_estimation";break;case"show_title":e="show_title_on_front";break;case"mandatory":e="mandatory_answer";break;case"assessable":e="gradable_answer";break;case"minimum_grade":e="minimum_grade_required";break;case"allow_retries":return s=this.get("meta"),s.limit_attempts?(a=s.limit_attempts[0],!this.fix_boolean(a)):t;case"retry_attempts":e="limit_attempts_value";break;case"order":e="module_order";break;case"page":e="module_page";break;case"answers_selected":e="input-radio"===this.module_type()?"checked_answer":"checked_answers"}return s=this.get("meta")||{},a=s[e]?s[e]:t
},fix_legacy_module:function(e){var t=this,s=t.get("meta");if(t.set("flag","dirty"),s.module_type=e,s.checked_answer&&(s.answers_selected=s.checked_answer),s.checked_answers&&(s.answers_selected=s.checked_answers),s.time_estimation&&(s.duration=s.time_estimation),s.show_title_on_front&&(s.show_title=t.fix_boolean(s.show_title_on_front)),s.mandatory_answer&&(s.mandatory=t.fix_boolean(s.mandatory_answer)),s.gradable_answer&&(s.assessable=t.fix_boolean(s.gradable_answer)),s.minimum_grade_required&&(s.minimum_grade=s.minimum_grade_required),s.limit_attempts){var a=t.fix_boolean(s.limit_attempts);s.allow_retries=!a}s.limit_attempts_value&&(s.retry_attempts=s.limit_attempts_value),t.set("meta",s)},map_legacy_type:function(e){var t=this,s={audio_module:"audio",chat_module:"chat",checkbox_input_module:"input-checkbox",file_module:"download",file_input_module:"input-upload",image_module:"image",radio_input_module:"input-radio",page_break_module:"section",section_break_module:"section",text_module:"text",text_input_module:"input-text",textarea_input_module:"input-textarea",video_module:"video"};return e in s&&(e="single"!==this.get_meta("checked_length","single")?"input-textarea":s[e],t.fix_legacy_module(e)),e},module_type:function(){return this.map_legacy_type(this.get_meta("module_type"))},fix_boolean:function(e){var t=_.isString(e)?e.toLowerCase():e;return 1===parseInt(t)||"on"===t||"yes"===t||!0===t},set_meta:function(e,t){e=e.replace("meta_","");var s=this.get("meta")||{};s[e]=t,this.set("flag","dirty"),this.set("meta",s),this.trigger("change")},from_template:function(t){var s=JSON.parse(_coursepress.unit_builder_templates[t]);this.set("ID",s.id),this.set("post_title",s.title),this.set_meta("duration",s.duration||"1:00"),this.set_meta("module_type",s.type),this.set_meta("mandatory",s.mandatory),this.set_meta("show_title",s.show_title||!0),this.set_meta("assessable",s.assessable),this.set_meta("minimum_grade",s.minimum_grade),this.set_meta("allow_retries",s.allow_retries),this.set_meta("retry_attempts",s.retry_attempts),"input-quiz"===s.type&&this.set_meta("use_timer",s.use_timer),this.set("post_content",s.content||""),this.set_meta("order",s.order);var a=this;e.each(s.components,function(t,s){e.each(s.items,function(e,t){a.item_to_meta(t)})})},item_to_meta:function(e){var t=this;switch(e.type){case"media-browser":case"text-input":t.set_meta(e.name,"");break;case"checkbox-select":case"select-select":case"radio-select":t.set_meta(e.name,e.answers),t.set_meta(e.name+"_selected",e.selected);break;case"media-caption-settings":t.set_meta(e.enable_name,!1),t.set_meta(e.option_name,"media"),t.set_meta(e.input_name,"");break;case"checkbox":t.set_meta(e.name,!1)}},model_saved:function(e){CoursePress.UnitBuilder.activeModuleRef=e.cid,CoursePress.UnitBuilder.gotoAdded=!0},process_changed:function(){CoursePress.UnitBuilder.activeModuleRef=this.cid,this.set("flag","dirty")}}),CoursePress.Collections.UnitTabs=Backbone.Collection.extend({model:CoursePress.Models.Unit}),CoursePress.Collections.UnitModules=Backbone.Collection.extend({model:CoursePress.Models.Module}),CoursePress.Views.UnitTabView=Backbone.View.extend({render:function(){var t=this.model.get("post_status"),s=this.model.get("meta"),a={unit_id:this.model.get("ID"),unit_title:this.model.get("post_title"),unit_live_class:"publish"===t?"unit-live":"unit-draft",unit_active_class:this.first?"active":"",unit_order:s.unit_order,unit_cid:this.model.cid},r=_.template(e("#unit-builder-tab-template").html(),a);return this.$el=r,this}}),CoursePress.Views.UnitTabViewCollection=Backbone.View.extend({initialize:function(){this.model.on("sync",this.render,this)},events:{},render:function(){var e=this;e.$el.empty();var t=!0;return this.model.each(function(s){var a=new CoursePress.Views.UnitTabView({model:s,tagName:"li"});a.first=t,e.$el.append(a.render().$el),t?CoursePress.Helpers.changeUnit(s,e):(e.parentView.contentView.initial=!0,e.parentView.contentView.render()),t=!1}),this.model.trigger("rendered"),this},changeActive:function(t){e("#unit-builder .tab-tabs li").removeClass("active"),e(t.currentTarget).addClass("active");var s=e(t.currentTarget).attr("data-tab"),a=this;this.model.each(function(t){parseInt(s)===parseInt(t.get("ID"))&&(CoursePress.Helpers.changeUnit(t,a),e("body,html").animate({scrollTop:e(".section.unit-builder-header").offset().top-20,duration:200}))})}}),CoursePress.Helpers.changeUnit=function(e,t,s){t=CoursePress.UnitBuilder,void 0===s&&(s=1),t.activePage=s,t.headerView.template_variables.unit_id=e.get("ID"),t.headerView.template_variables.unit_cid=e.cid,t.headerView.template_variables.unit_title=e.get("post_title"),t.headerView.template_variables.unit_content=e.get("post_content");var a=e.get("meta");t.headerView.template_variables.unit_availability=a.unit_availability,t.headerView.template_variables.unit_date_availability=a.unit_date_availability?a.unit_date_availability:"",t.headerView.template_variables.unit_delay_days=a.unit_delay_days?a.unit_delay_days:0,t.headerView.template_variables.unit_feature_image=a.unit_feature_image;var r=a.force_current_unit_completion;r="on"===r||!0===r||1===r?'checked="checked"':"",t.headerView.template_variables.unit_force_completion_checked=r,r=a.force_current_unit_successful_completion,r="on"===r||!0===r||1===r?'checked="checked"':"",t.headerView.template_variables.unit_force_successful_completion_checked=r,t.headerView.render(),t.headerView.$el.find("#unit_availability").trigger("change"),t.contentView.initial=!0,t.contentView.render(),t.activeUnitID=e.get("ID"),t.activeUnitRef=e.cid,t.activeUnitStatus=e.get("post_status"),t.fetchModules(t.activeUnitID,t.activePage)},CoursePress.Views.UnitBuilderHeader=Backbone.View.extend({initialize:function(){this.template_variables={unit_id:"",unit_cid:"",unit_title:"",unit_content:"",unit_feature_image:"",unit_availability:"",unit_date_availability:"",unit_delay_days:0,unit_force_completion_checked:"",unit_force_successful_completion_checked:""},this.render(),CoursePress.Events.on("editor:keyup",this.editorChanged,this)},events:{"change .unit-detail input":"fieldChanged","keyup .unit-detail input[name=post_title]":"updateTabTitle","keyup .unit-detail #unit_description_1_1":"editorChanged","change #unit-live-toggle":"toggleUnitState","change #unit-live-toggle-2":"toggleUnitState","change #unit_feature_image":"unitFeatureImageChange","change [name=unit_feature_image-button]":"unitFeatureImageChange","change [name=meta_unit_availability]":"toggleAvailability","focus [name=meta_unit_date_availability]":"setDate","change select":"fieldChanged"},render:function(){var t=this.template_variables;0===parseInt(t.unit_delay_days)&&(t.unit_delay_days="");var s=_.template(e("#unit-builder-header-template").html(),t);return this.$el.html(s),e("#unit_feature_image").val(t.unit_feature_image),this.updateUnitHeader(),this},editorChanged:function(t){var s=t.id;if(void 0===s&&(s=e(t.currentTarget).attr("id")),void 0!==s&&"unit_description_1_1"===s){var a=e("#"+s),r=CoursePress.editor.content(s),i=e(a).parents(".unit-detail")[0],n=this.parentView.unit_collection._byId[e(i).attr("data-cid")];n.set("post_content",r)}},fieldChanged:function(t){var s=e(t.currentTarget),a=e(s).attr("name");if("unit_feature_image"!==a&&"unit_feature_image-button"!==a&&"page_feature_image"!==a&&"page_feature_image-button"!==a){var r=e(s).val(),i=e(s).parents(".unit-detail")[0],n=this.parentView.unit_collection._byId[e(i).attr("data-cid")],o=e(s).attr("type");"checkbox"===o&&(r=e(s).is(":checked")),n&&(/meta_/.test(a)?n.set_meta(a,r):n.set(a,r))}},unitFeatureImageChange:function(t){var s=e(t.currentTarget),a=e("#unit_feature_image").val(),r=e(s).parents(".unit-detail")[0],i=this.parentView.unit_collection._byId[e(r).attr("data-cid")];i.set_meta("unit_feature_image",a)},updateTabTitle:function(t){e('[data-tab="'+this.parentView.activeUnitID+'"] span').html(e(t.currentTarget).val())},toggleUnitState:function(e){CoursePress.Helpers.Module.toggle_unit_state(e)},updateUnitHeader:function(){e.each(e("#unit_description_1_1"),function(t,s){var a=e(s).attr("id");delete tinyMCEPreInit.mceInit[a],delete tinyMCEPreInit.qtInit[a],delete tinyMCE.EditorManager.editors[a];var r=e("#"+a).val(),i=e(s).attr("name"),n=e(s).attr("data-height")?e(s).attr("data-height"):200;CoursePress.editor.create(s,a,i,r,!1,n)})},toggleAvailability:function(t){var s=e(t.target),a=s.val(),r=e(".ua-div"),i=e("#div-"+a);r.hide(),i.length>0&&i.show()},setDate:function(t){var s=e(t.target);s.datepicker()}}),CoursePress.Views.UnitBuilderFooter=Backbone.View.extend({render:function(){var t=_.template(e("#unit-builder-footer-template").html(),{});return this.$el.empty(),this.$el.html(t),this}}),CoursePress.Views.UnitBuilderBody=Backbone.View.extend({initialize:function(){this.initial=!0,this.pagerView=new CoursePress.Views.UnitBuilderPager({className:"section unit-builder-pager"}),this.pagerView.parentView=this,this.pagerView.template_variables={},this.pagerViewInfo=new CoursePress.Views.UnitBuilderPagerInfo({className:"section unit-builder-pager-info"}),this.pagerViewInfo.parentView=this,this.pagerViewInfo.template_variables={},this.componentsView=new CoursePress.Views.UnitBuilderComponents({className:"section unit-builder-components"}),this.componentsView.parentView=this,this.componentsView.template_variables={},this.modulesView=new CoursePress.Views.UnitBuilderModules({className:"section unit-builder-modules"}),this.modulesView.parentView=this,this.modulesView.template_variables={},this.footerView=new CoursePress.Views.UnitBuilderFooter({className:"unit-buttons"}),this.footerView.parentView=this,this.model.on("sync",this.render,this),CoursePress.Events.on("editor:keyup",this.editorChanged,this)},render:function(){var t;if(this.initial)t=_.template(e("#unit-builder-content-placeholder").html(),{}),this.$el.html(t),this.initial=!1;else{t=_.template(e("#unit-builder-content-template").html(),{}),this.$el.html(t);var s=this.parentView.unit_collection._byId[this.parentView.activeUnitRef];this.pagerView.template_variables.unit_page_count=this.parentView.totalPages,this.$(".unit-builder-pager").replaceWith(this.pagerView.render(this.pagerView.template_variables).el),s=this.parentView.unit_collection._byId[this.parentView.activeUnitRef];var a=s.get_page_visibility(this.parentView.activePage);if(a=a||!1===a?_.isString(a)&&("yes"===a.toLowerCase()||"on"===a.toLowerCase())||1===parseInt(a)||!0===a:!0,this.pagerViewInfo.template_variables={page_label_text:s.get_page_title(this.parentView.activePage),page_description:s.get_page_description(this.parentView.activePage),page_feature_image:s.get_page_image(this.parentView.activePage),page_label_checked:a?'checked="checked"':""},this.$(".unit-builder-pager-info").replaceWith(this.pagerViewInfo.render(this.pagerViewInfo.template_variables).el),this.componentsView.template_variables={},this.$(".unit-builder-components").replaceWith(this.componentsView.render(this.componentsView.template_variables).el),this.$(".unit-builder-modules").replaceWith(this.modulesView.render(this.parentView.module_collection.models).el),this.$(".unit-builder-footer").append(this.footerView.render().el),CoursePress.Helpers.Module.refresh_ui(),this.updateSectionEditor(),e("#page_feature_image").val(this.pagerViewInfo.template_variables.page_feature_image),CoursePress.UnitBuilder.gotoAdded===!0){CoursePress.UnitBuilder.gotoAdded=!1;var r=e("[data-cid="+CoursePress.UnitBuilder.activeModuleRef+"]");e("body,html").scrollTop(e(r).offset().top-80)}}return this},events:{"click .unit-builder-components .output-element":"add_element","click .unit-builder-components .input-element":"add_element","change .button.browse-media-field":"fieldChanged","change .module-holder input":"fieldChanged","change textarea":"fieldChanged","change select":"selectionChanged","change .page-info-holder input":"unitPageInfoChanged","keyup .module-title-text":"updateUIHeading","click .unit-builder-pager ul li":"changePage","click .module-component .add-item":"addAnswer","click .module-component .remove-item":"removeAnswer","change #page_feature_image":"pageFeatureImageChange","change [name=page_feature_image-button]":"pageFeatureImageChange"},pageFeatureImageChange:function(t){var s=e(t.currentTarget),a=e("#page_feature_image").val(),r=this.parentView.activePage,i=e(e(s).parents(".unit-builder-content")[0]).find(".unit-detail")[0],n=this.parentView.unit_collection._byId[e(i).attr("data-cid")];n.set_page_image(r,a)},add_element:function(t){var s=t.currentTarget,a=e(s).attr("class").match(/module-(\w|-)*/g)[0].trim().replace("module-",""),r=e(".module-holder").length,i=new CoursePress.Models.Module;i.from_template(a),i.set_meta("module_order",r+1),i.set_meta("module_page",this.parentView.activePage),i.save(),this.parentView.module_collection.add(i)},fieldChanged:function(t){var s=e(t.currentTarget),a=e(s).attr("name");if("unit_feature_image"!==a&&"unit_feature_image-button"!==a&&"page_feature_image"!==a&&"page_feature_image-button"!==a){var r,i=e(s).val(),n=e(s).parents(".module-holder")[0],o=this.parentView.module_collection._byId[e(n).attr("data-cid")],u=e(s).attr("type");if("checkbox"===u&&(r=e('[name="'+a+'"]'),a=a.replace(/\[.*\]/,""),r.length>1?(i=[],e.each(r,function(t,s){e(s).is(":checked")&&i.push(t)})):i=e(s).is(":checked")),"radio"===u&&(a=a.replace(/\[.*\]/,"")),("text"===u||"textbox"===u)&&/\[\]/.test(a)){var l=e(s).parents(".module-component");if(l.length>0)return r=e(l).find('[name="'+a+'"]'),a=a.replace(/\[.*\]/,""),i=[],e.each(r,function(t,s){i.push(e(s).val())}),o.set_meta(a,i),void 0}if("button"===u&&e(s).hasClass("browse-media-field")){var c=e(e(s)[0]).siblings("[type=text]")[0];a=e(c).attr("name"),i=e(c).val()}/meta_/.test(a)?o.set_meta(a,i):o.set(a,i)}},selectionChanged:function(t){var s=e(t.currentTarget),a=e(s).attr("name"),r=e(s).val(),i=e(s).parents(".module-holder")[0],n=this.parentView.module_collection._byId[e(i).attr("data-cid")];/meta_/.test(a)?n.set_meta(a,r):n.set(a,r)},editorChanged:function(t){var s=t.id,a=e("#"+s).parents(".module-holder")[0];if(void 0!==a){var r=this.parentView.module_collection._byId[e(a).attr("data-cid")],i=/post_content_/.test(s)?s.replace(/(_\d+)+$/,""):s,n=CoursePress.editor.content(s);/meta_/.test(i)?r.set_meta(i,n):r.set(i,n)}},updateUIHeading:function(t){var s=t.currentTarget,a=e(e(s).parents(".module-holder")[0]).siblings("h3")[0];e(a).find(".label").html(e(s).val())},changePage:function(t){var s=this,a=e(t.currentTarget).attr("data-page"),r=s.parentView.unit_collection._byId[s.parentView.activeUnitRef];a?(s.parentView.activePage=e(t.currentTarget).attr("data-page"),s.parentView.fetchModules(s.parentView.activeUnitID,s.parentView.activePage)):(s.parentView.activePage=e(".unit-builder-pager ul li").length,s.parentView.totalPages=s.parentView.activePage,r.set_page_title(s.parentView.activePage,""),r.set_page_visibility(s.parentView.activePage,!0),s.parentView.fetchModules(s.parentView.activeUnitID,s.parentView.activePage))},unitPageInfoChanged:function(t){var s=e(t.currentTarget),a=e(s).attr("name"),r=e(s).val(),i=this.parentView.unit_collection._byId[this.parentView.activeUnitRef],n=e(s).attr("type");switch("checkbox"===n&&(r=e(s).is(":checked")),a){case"page_title":i.set_page_title(this.parentView.activePage,r);break;case"show_page_title":i.set_page_visibility(this.parentView.activePage,r)}i.trigger("change")},addAnswer:function(t){var s=t.currentTarget,a=e(s).siblings(".answer-group"),r=e(s).parents(".module-holder"),i=e(r).attr("data-cid"),n=e(r).find(".answer"),o=n.length,u=e(e(s).parents(".module-holder")[0]).attr("class").match(/input-radio/)?"radio":"checkbox",l=e(e(s).parents(".module-holder")[0]).attr("class").match(/input-radio/)?"meta_answers_selected["+i+"]":"meta_answers_selected["+i+"][]";e(a).append('<div class="answer"><input type="'+u+'" value="'+o+'" name="'+l+'">'+'<input class="component-'+u+'-answer wide" type="text" name="meta_answers[]" value="">'+' <span class="remove-item"><i class="fa fa-trash-o"></i></span></div>')},removeAnswer:function(t){var s=t.currentTarget,a=e(s).parents(".answer-group"),r=e(s).parents(".answer"),i=e(s).parents(".module-holder"),n=e(i).attr("data-cid"),o=this.parentView.module_collection._byId[n];r.detach();var u=e(a).find('[name="meta_answers_selected['+n+'][]"]'),l=[];e.each(u,function(t,s){e(s).is(":checked")&&l.push(t),e(s).val(t)}),o.set_meta("meta_answers_selected",l),u=e(a).find('[name="meta_answers[]"]'),l=[],e.each(u,function(t,s){l.push(e(s).val())}),o.set_meta("meta_answers",l)},updateSectionEditor:function(){e.each(e("#page_description_1_1"),function(t,s){var a=e(s).attr("id");delete tinyMCEPreInit.mceInit[a],delete tinyMCEPreInit.qtInit[a],delete tinyMCE.EditorManager.editors[a];var r=e("#"+a).val(),i=e(s).attr("name"),n=e(s).attr("data-height")?e(s).attr("data-height"):200;CoursePress.editor.create(s,a,i,r,!1,n)})}}),CoursePress.Views.UnitBuilderPager=Backbone.View.extend({render:function(t){var s=_.template(e("#unit-builder-pager-template").html(),t);return this.$el.html(s),this}}),CoursePress.Views.UnitBuilderPagerInfo=Backbone.View.extend({initialize:function(){CoursePress.Events.on("editor:keyup",this.editorChanged,this)},events:{"change .page-info-holder input":"fieldChanged","keyup .unit-detail #page_description_1_1":"editorChanged"},render:function(t){var s=_.template(e("#unit-builder-pager-info-template").html(),t);return this.$el.html(s),this},editorChanged:function(t){var s=this.parentView.parentView.activePage,a=t.id;if(void 0===a&&(a=e(t.currentTarget).attr("id")),void 0!==a&&"page_description_1_1"===a){var r=e("#"+a),i=CoursePress.editor.content(a),n=e(e(r).parents(".unit-builder-content")[0]).find(".unit-detail")[0],o=this.parentView.parentView.unit_collection._byId[e(n).attr("data-cid")];window.console.log(o),o.set_page_description(s,i)}}}),CoursePress.Views.UnitBuilderComponents=Backbone.View.extend({render:function(t){var s=_.template(e("#unit-builder-components-template").html(),t);return this.$el.html(s),this}}),CoursePress.Views.UnitBuilderModules=Backbone.View.extend({render:function(){var e=this;return e.$el.empty(),this.parentView.model.each(function(t){var s=new CoursePress.Views.ModuleView({model:t,tagName:"div",className:"group"}),a=t.get_meta("module_order");e.$el.append(s.render(t,a).$el)}),this}}),CoursePress.Views.ModuleView=Backbone.View.extend({render:function(e,t){var s=this;return s.$el.empty(),s.$el.append(CoursePress.Helpers.Module.render_module(e,t)),CoursePress.Helpers.Module.refresh_ui(),this}}),e(document).ready(function(){t()})})(jQuery);