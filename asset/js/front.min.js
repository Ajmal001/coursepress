/*!  - v2.0.0
 * 
 * Copyright (c) 2016; * Licensed GPLv2+ */
var CoursePress={};CoursePress.Events=_.extend({},Backbone.Events),function(a){CoursePress.SendRequest=Backbone.Model.extend({url:_coursepress._ajax_url+"?action=coursepress_request",parse:function(a){var b=this.get("action");!0===a.success?(this.set("response_data",a.data),this.trigger("coursepress:"+b+"_success",a.data)):(this.set("response_data",{}),this.trigger("coursepress:"+b+"_error",a.data))}}),CoursePress.resetBrowserURL=function(a){window.history.pushState&&window.history.pushState({},null,a)},CoursePress.showError=function(b,c){var d,e=a('<div class="cp-error-box"></div>'),f=a("<p>"),g=a('<a class="cp-closed">&times;</a>');d=function(){e.remove()},f.html(b).appendTo(e),g.prependTo(e).on("click",d),c.prepend(e)},CoursePress.Focus=function(b){var c,d=a(b);return 0<d.length&&(c=d.offset().top,a(window).scrollTop(c)),!1}}(jQuery),function(a){CoursePress.LoadFocusModule=function(){var b=a(this),c=b.data(),d=a(".coursepress-focus-view"),e=[_coursepress.home_url,"coursepress_focus"];if("submit"!==b.attr("type"))return"course"===c.type?void(window.location=c.url):(e.push(c.course,c.unit,c.type,c.id),e=e.join("/"),d.load(e),CoursePress.resetBrowserURL(c.url),!1)},CoursePress.ModuleSubmit=function(){var b=a(this),c=b.find(".cp-error"),d=b.parents(".coursepress-focus-view"),e=!1,f=!1;0===c.length&&(c=a('<div class="cp-error">').prependTo(b)),b.append('<input type="hidden" name="is_cp_ajax" value="1" />'),e=a('<iframe name="cp_submitter" style="display:none;">').insertBefore(b),b.attr("target","cp_submitter"),e.on("load",function(){var b=a(this).contents().find("body");f=setInterval(function(){var a=b.text();if(""!=a){clearInterval(f);var e=window.JSON.parse(a);!0===e.success?e.data.url&&(e.data.type&&"completion"===e.data.type?window.location=e.data.url:(d.html(e.data.html),CoursePress.resetBrowserURL(e.data.url))):c.empty().append(e.data.error_message)}},100)})},CoursePress.toggleModuleState=function(){var b=a(this),c=b.closest(".cp-module-content"),d=a(".module-elements",c),e=a(".module-response",c);return e.hide(),d.show(),!1},CoursePress.commentReplyLink=function(){var b=a(this),c=b.parents("[data-comid]").first(),d=c.data("comid"),e=b.parents(".cp-module-content").first(),f=a("#respond",e),g=a("#comment-"+d),h=a('[name="comment_parent"]',f),i=a(".cp-temp-div"),j=f.find("#cancel-comment-reply-link");return 0===i.length&&(i=a('<div class="cp-temp-div"></div>').insertAfter(f)),h.val(d),g.append(f),j.show().on("click",function(){return f.insertBefore(i),j.hide(),i.remove(),!1}),CoursePress.Focus(f),!1},CoursePress.addComment=function(b){var c,d=a(this),e=d.parents(".cp-module-content").first(),f=a("#respond",e),g=a(".cp-comment-form",e),h=a('[name="comment"]',f),i=a('[name="comment_parent"]',f),j=a('[name="comment_post_ID"]',f),k=a('[name="coursepress_subscribe"]',f),l=a('[name="student_id"]',e),m=a('[name="course_id"]',e),n=a('[name="module_content"]',e),o=a(".cp-error-box",f),p=a(".comment-list",e),q={},r=0<parseInt(i.val()),s=new CoursePress.SendRequest;return o.remove(),""===h.val()?(CoursePress.showError(_coursepress.comments.require_valid_comment,f),b.stopImmediatePropagation(),!1):(q={comment:h.val(),comment_parent:i.val(),comment_post_ID:j.val(),subscribe:k.val(),cpnonce:_coursepress.cpnonce,method:"add_single_comment",className:"CoursePress_Module",course_id:m,unit_id:n,student_id:l,action:"add_single_comment"},c=function(){var a=f.find("#cancel-comment-reply-link");h.val(""),i.val(""),a.is(":visible")&&a.trigger("click")},s.set(q),s.off("coursepress:add_single_comment_success"),s.on("coursepress:add_single_comment_success",function(b){c(),0<p&&(p=a('<ol class="comment-list"></ol>').insertAfter(f));var d,e=p,h=g.is(".comment-form-desc")?"append":"prepend";!0===r?(e=a("#comment-"+q.comment_parent),d=e.find(".children"),0===d.length?(e.append('<ul class="children"></ul>'),d=e.find(".children")):d="append"===h?d.first():d.last(),d[h](b.html)):e[h](b.html),CoursePress.Focus("#comment-"+b.comment_id)}),s.on("coursepress:add_single_comment_error",function(){window.alert("error")}),s.save(),b.stopImmediatePropagation(),!1)},a(document).on("submit",".cp-form",CoursePress.ModuleSubmit).on("click",".focus-nav-prev, .focus-nav-next",CoursePress.LoadFocusModule).on("click",".button-reload-module",CoursePress.toggleModuleState).on("click",".cp-module-content .comment-reply-link",CoursePress.commentReplyLink).on("click",".cp-comment-submit",CoursePress.addComment)}(jQuery);