/*!  - v2.0.0
 * 
 * Copyright (c) 2016; * Licensed GPLv2+ */
var CoursePress={};CoursePress.Events=_.extend({},Backbone.Events),function(a){CoursePress.SendRequest=Backbone.Model.extend({url:_coursepress._ajax_url+"?action=coursepress_request",parse:function(a){var b=this.get("action");!0===a.success?(this.set("response_data",a.data),this.trigger("coursepress:"+b+"_success",a.data)):(this.set("response_data",{}),this.trigger("coursepress:"+b+"_error",a.data))}}),CoursePress.resetBrowserURL=function(a){window.history.pushState&&window.history.pushState({},null,a)},CoursePress.Focus=function(b){var c,d=a(b);return 0<d.length&&(c=d.offset().top,c-=100,a(window).scrollTop(c)),!1},CoursePress.showError=function(b,c){var d,e=a('<div class="cp-error-box"></div>'),f=a("<p>"),g=a('<a class="cp-closed">&times;</a>');d=function(){e.remove()},f.html(b).appendTo(e),g.prependTo(e).on("click",d),c.prepend(e),CoursePress.Focus(".cp-error-box")},CoursePress.Mask=function(b){b=b?b:"body";var c=a('<div class="cp-mask mask"></div>');return c.appendTo(b),{mask:c,done:function(){c.remove()}}},CoursePress.UnitProgressIndicator=function(){var b=a("ul.units-archive-list a").css("color"),c=a("body").css("color").replace("rgb(","").replace(")","").split(","),d="rgba("+c[0]+", "+c[1]+", "+c[2]+", 1)",e=a(this).data(),f=b,g="center",h=4.5,i=!0,j={duration:1200,easing:"circleProgressEase"};e.knobFgColor&&(b=e.knobFgColor),e.knobEmptyColor&&(d=e.knobEmptyColor),e.knobTextColor&&(f=e.knobTextColor),e.knobTextAlign&&(g=e.knobTextAlign),e.knobTextDenominator&&(h=e.knobTextDenominator),"undefined"!=typeof e.knobTextShow&&(i=e.knobTextShow),"undefined"!=typeof e.knobAnimation&&(j=e.knobAnimation);var k={color:b};a(this).circleProgress({fill:k,emptyFill:d,animation:j});a(this).parents("ul")[0];a(this).on("circle-animation-progress",function(b,c){var d=a(this).data("circle-progress"),e=d.ctx,j=d.size,k=(100*c).toFixed(),l=(100*d.value).toFixed();k=100-k,k<l&&(k=l),e.save(),i&&(e.font=j/h+"px sans-serif",e.textAlign=g,e.textBaseline="middle",e.fillStyle=f,e.fillText(k+"%",j/2+j/80,j/2)),e.restore()}),a(this).on("circle-animation-end",function(){var b=a(this).data("circle-progress"),c=b.ctx,d=b.size,e=(100*b.value).toFixed();b.drawFrame(b.value),i&&(c.font=d/h+"px sans-serif",c.textAlign=g,c.textBaseline="middle",c.fillStyle=f,c.fillText(e+"%",d/2,d/2))});var l=a(this).data("circle-progress"),m=l.ctx,n=l.size,o=(100*l.value).toFixed();i&&(m.font=n/h+"px sans-serif",m.textAlign=g,m.textBaseline="middle",m.fillStyle=f,m.fillText(o+"%",n/2,n/2+n/80)),"undefined"!=typeof e.knobTextPrepend&&e.knobTextPrepend&&a(this).parent().prepend('<span class="progress">'+o+"%</span>")},a(document).ready(function(){a(".course-progress-disc").each(CoursePress.UnitProgressIndicator)})}(jQuery),function(a){CoursePress.LoadFocusModule=function(){var b=a(this),c=b.data(),d=a(".coursepress-focus-view"),e=[_coursepress.home_url,"coursepress_focus"];if("submit"!==b.attr("type"))return"course"===c.type?void(window.location=c.url):(e.push(c.course,c.unit,c.type,c.id),e=e.join("/"),d.load(e),CoursePress.resetBrowserURL(c.url),!1)},CoursePress.ModuleSubmit=function(){var b=a(this),c=b.find(".cp-error"),d=b.parents(".coursepress-focus-view"),e=!1,f=!1;0===c.length&&(c=a('<div class="cp-error">').prependTo(b)),b.append('<input type="hidden" name="is_cp_ajax" value="1" />'),e=a('<iframe name="cp_submitter" style="display:none;">').insertBefore(b),b.attr("target","cp_submitter"),e.on("load",function(){var b=a(this).contents().find("body");f=setInterval(function(){var a=b.text();if(""!=a){clearInterval(f);var e=window.JSON.parse(a);!0===e.success?e.data.url&&(e.data.type&&"completion"===e.data.type?window.location=e.data.url:(d.html(e.data.html),CoursePress.resetBrowserURL(e.data.url))):c.empty().append(e.data.error_message)}},100)})},CoursePress.toggleModuleState=function(){var b=a(this),c=b.closest(".cp-module-content"),d=a(".module-elements",c),e=a(".module-response",c);return e.hide(),d.show(),!1},CoursePress.commentReplyLink=function(){var b=a(this),c=b.parents("[data-comid]").first(),d=c.data("comid"),e=b.parents(".cp-module-content").first(),f=a("#respond",e),g=a("#comment-"+d),h=a('[name="comment_parent"]',f),i=a(".cp-temp-div"),j=f.find("#cancel-comment-reply-link");return 0===i.length&&(i=a('<div class="cp-temp-div"></div>').insertAfter(f)),h.val(d),g.append(f),j.show().on("click",function(){return f.insertBefore(i),j.hide(),i.remove(),!1}),CoursePress.Focus(f),!1},CoursePress.addComment=function(b){var c,d,e=a(this),f=e.parents(".cp-module-content").first(),g=a("#respond",f),h=a(".cp-comment-form",f),i=a('[name="comment"]',g),j=a('[name="comment_parent"]',g),k=a('[name="comment_post_ID"]',g),l=a('[name="coursepress_subscribe"]',g),m=a('[name="student_id"]',f),n=a('[name="course_id"]',f),o=a('[name="module_content"]',f),p=a(".cp-error-box",g),q=a(".comment-list",f),r={},s=0<parseInt(j.val()),t=new CoursePress.SendRequest;return p.remove(),""===i.val()?(CoursePress.showError(_coursepress.comments.require_valid_comment,g),b.stopImmediatePropagation(),!1):(r={comment:i.val(),comment_parent:j.val(),comment_post_ID:k.val(),subscribe:l.val(),cpnonce:_coursepress.cpnonce,method:"add_single_comment",className:"CoursePress_Module",course_id:n,unit_id:o,student_id:m,action:"add_single_comment"},d=CoursePress.Mask(),c=function(){var a=g.find("#cancel-comment-reply-link");i.val(""),j.val(""),a.is(":visible")&&a.trigger("click"),d.done()},t.set(r),t.off("coursepress:add_single_comment_success"),t.on("coursepress:add_single_comment_success",function(b){c(),0<q&&(q=a('<ol class="comment-list"></ol>').insertAfter(g));var d,e=q,f=h.is(".comment-form-desc")?"append":"prepend";!0===s?(e=a("#comment-"+r.comment_parent),d=e.find(".children"),0===d.length?(e.append('<ul class="children"></ul>'),d=e.find(".children")):d="append"===f?d.last():d.first(),d[f](b.html)):e[f](b.html),CoursePress.Focus("#comment-"+b.comment_id)}),t.on("coursepress:add_single_comment_error",function(){d.done(),CoursePress.showError(_coursepress.server_error,g)}),t.save(),b.stopImmediatePropagation(),!1)},a(document).on("submit",".cp-form",CoursePress.ModuleSubmit).on("click",".focus-nav-prev, .focus-nav-next",CoursePress.LoadFocusModule).on("click",".button-reload-module",CoursePress.toggleModuleState).on("click",".cp-module-content .comment-reply-link",CoursePress.commentReplyLink).on("click",".cp-comment-submit",CoursePress.addComment)}(jQuery);